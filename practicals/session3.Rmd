---
title: "Integrative Simulation Exercises"
author: Kris Sankaran
output: rmdformats::readthedown
---

<script>
function myFunction(id) {
    var x = document.getElementById(id);
    if (x.style.display === "none") {
        x.style.display = "block";
    } else {
        x.style.display = "none";
    }
}
</script>
<style>
div .info {
  margin: auto;
  background-color: #EAF0FB;
  width: 95%;
  padding: 10px;
}
</style>

```{r}
suppressPackageStartupMessages({
  library(MIGsim)
  library(SummarizedExperiment)
  library(gamboostLSS)
  library(ggplot2)
  library(glue)
  library(mixOmics)
  library(purrr)
  library(scDesigner)
})
set.seed(20240603)
```

# Horizontal Integration

```{r}
data(alzheimers)
pca_batch(alzheimers)
```

```{r}
simulator <- setup_simulator(
  alzheimers,
  ~ batch + treatment,
  ~ GaussianLSS(),
  copula = copula_adaptive(thr = .1)
) |>
  estimate(nu = 0.05, mstop = 100)

alzheimers_sim <- sample(simulator)
contrast_histogram(alzheimers, alzheimers_sim)
```

```{r}
pca_batch(alzheimers_sim)
```

Question is whether it might overcorrect the new treatment group.

```{r}
data(imaginary_design)
alzheimers_sim <- sample(simulator, new_data = imaginary_design)
```

Now we can test batch effect correction in this new setting.

```{r}
pca_batch(batch_correct(alzheimers_sim, "ruv"))
pca_batch(batch_correct(alzheimers_sim, "combat"))
```

# Interlude: Using map

```{r}
map(1:3, ~ . ^ 2)
map(list(a = 1, b = 2, c = 3), ~ . + 1)
```


# Vertical Integration - Influence of Nulls

```{r}
data(icu)
simulator <- map(
  icu,
  ~ setup_simulator(., ~ Category, ~ GaussianLSS()) |>
    estimate(nu = 0.05)
)
x <- sample(simulator[[1]])
```

An example where we either do or do not have any true association with category,
to see how the integration outputs change.

```{r}
fit <- exper_splsda(icu)
plotIndiv(fit)
```

Question: Do you think weak disease associations in one assay influence the
dimensionality reduction outputs in another? If so, how?

```{r}
null_simulator <- simulator
null_simulator[[1]] <- simulator[[1]] |>
  scDesigner::mutate(1:180, link = ~ 1, family = ~ GaussianLSS()) |>
  estimate(nu = 0.05)

# null_simulator[[2]] <- simulator[[2]] |>
#   scDesigner::mutate(1:18, link = ~ 1, family = ~ GaussianLSS()) |>
#   estimate(nu = 0.05)
```

```{r}
icu_sim <- map(null_simulator, sample)
fit <- exper_splsda(icu_sim)
plotIndiv(fit)
```
