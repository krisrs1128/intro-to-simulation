---
title: "Joint Simulation Exercises"
author: Kris Sankaran
output: readthedown::html_document
---

```{r}
library(MIGsim)
library(SummarizedExperiment)
library(gamboostLSS)
library(glue)
library(mixOmics)
library(tidyverse)
library(scDesigner)
```

### Interpreting PLS-DA

```{r}
exper <- readRDS("../data/t1d.rds")
result <- splsda_fit(exper)
plotIndiv(result$fit)
plotLoadings(result$fit)
```

### PLS-DA Power Analysis

```{r}
signal_order <- readRDS("../data/t1d_order.rds")
simulator <- setup_simulator(
  exper,
  link_formula = ~outcome2,
  family = ~GaussianLSS()
) |>
  estimate()

sim_exper <- sample(simulator)
sim_exper
```

```{r}
update_simulator <- function(simulator, n_nonnull, signal_order) {
  exper <- simulator@template
  nonnull <- rownames(exper)[signal_order[1:n_nonnull]]
  simulator |>
    mutate(dplyr::any_of(nonnull), link = ~outcome2) |>
    estimate()
}
```

```{r, power-analysis-params}
configs <- expand.grid(
  sample_size = floor(seq(10, 200, length.out = 5)),
  n_nonnull = floor(seq(10, 110, length.out = 4)),
  n_rep = 1
)

metrics <- vector(length = nrow(configs))
```

```{r power-analysis-loop}
for (i in seq_len(nrow(config))) {
  simulator <- update_simulator(simulator, n_nonnull = n_nonnull[i], signal_order)
  metrics[i] <- sample_n(simulator, config$sample_size[j]) |>
    splsda_fit() %>%
    .[["auc"]]
  print(glue("run {k}/{nrow(config)}"))
}
```

```{r}
configs$metrics <- metrics

ggplot(configs) +
  geom_point(aes(sample_size, metric))

```

```{r}
ggplot(results) +
  geom_point()
```

### Simulator Evaluation
