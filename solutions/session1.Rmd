---
title: "Marginal Analysis Example"
author: Kris Sankaran
output: readthedown::html_document
---

```{r}
library(MIGsim) # devtools::install_github("krisrs1128/intro-to-simulation/MIGsim")
library(gamboostLSS)
library(ggdist)
library(glue)
library(splines)
library(tidyverse)
library(scDesigner)
```

### Using SummarizedExperiment

* How many genera are available in this experiment object?
* What was the most common phylum in this dataset?
* What was the average participant age?

```{r}
data(atlas)
dim(atlas) # 125 genera
table(rowData(atlas)$Phylum)

mean(colData(atlas)$age)

# or just,
mean(atlas$age)
```

### Demo: Gaussian over Time

```{r}
data(exper_ts)
exper_lineplot(exper_ts)
```

```{r}
sim <- setup_simulator(
  exper_ts,
  ~ ns(time, df = 7) * group,
  ~ GaussianLSS()
) |>
  estimate(nu = 0.01, mstop = 1000)

sample(sim) |>
  exper_lineplot()
```

```{r}
sim <- sim |>
  mutate(4:6, link = ~ ns(time, df = 7)) |>
  estimate(nu = 0.01, mstop = 1000)

sample(sim) |>
  exper_lineplot()
```


### Exercise: Gaussian Mixture

```{r}
data(exper_grouped)
exper_histogram(exper_grouped)
```

* Explain how the simulation code below works. 
* Modify it so that it accurate reflects the difference between groups for the first three genes.

```{r}
sim <- setup_simulator(exper_grouped, ~1, ~ GaussianLSS()) |>
  estimate()

sample(sim) |>
  exper_histogram()
```

```{r}
sim <- sim |>
  mutate(1:3, link = ~group) |>
  estimate()

sample(sim) |>
  exper_histogram()
```

### Estimate and Visualize

```{r}
data(atlas)

fmla <- list(
  mu = ~bmi_group + log_depth,
  sigma = ~bmi_group + log_depth,
  nu = ~ 1
)
sim <- setup_simulator(
  atlas,
  fmla,
  ~ ZINBLSS()
) |>
  estimate(nu = 0.005, mstop = 1000)
```

```{r}
#library(mbImpute)
#metadata <- colData(atlas) |>
#  as_tibble() |>
#  select(age, sex, project)
#atlas_impute <- mbImpute(condition = atlas$bmi_group, t(assay(atlas)), metadata = metadata)
# sim <- setup_simulator(
#   atlas_impute,
#   ~ bmi_group,
#   ~ GaussianLSS()
# ) |>
#   estimate(nu = 0.005, mstop = 500)
```

Visualizing simulator quality.

```{r}
atlas_ <- sample(sim)
combined <- bind_rows(
  real = pivot_experiment(atlas), # real data
  simulated = pivot_experiment(atlas_), # simulated
  .id = "source"
)

ggplot(combined) +
  geom_boxplot(
    aes(asinh(value), reorder(feature, value, median), fill = bmi_group)
  ) +
  facet_grid(. ~ source)
```

### Apply to Power Analysis

Re-estimate the model with all taxa initially set to NULL.

```{r}
null_fmla <- list(
  mu = ~log_depth,
  sigma = ~log_depth,
  nu = ~1
)

nonnull_fmla <- list(
  mu = ~bmi_group + log_depth,
  sigma = ~bmi_group + log_depth,
  nu = ~1
)

sim_ <- setup_simulator(
  atlas,
  null_fmla,
  ~ ZINBLSS()
) |>
  estimate(nu = 0.005, mstop = 1000)
```

```{r}
signal_order <- run_DA_method(assay(atlas), colData(atlas), "LIMMA_voom") |>
  rownames()

configs <- expand.grid(
  sample_size = floor(seq(50, 1500, length.out = 10)),
  n_rep = 1:20,
  n_nonnull = 8
)

results <- list()
for (i in seq_len(nrow(configs))) {
  # re-estimate the simulator whenever # of true signals changes
  nonnull <- signal_order[1:configs$n_nonnull[i]]
  if (i == 1 || configs$n_nonnull[i] != configs$n_nonnull[i - 1]) {
    sim_ <- sim_ |>
      mutate(dplyr::any_of(nonnull), link = nonnull_fmla) |>
      estimate(nu = 0.005, mstop = 500)
  }

  # generate data and run tests
  atlas_ <- sample_n(sim_, configs$sample_size[i])
  colnames(atlas_) <- glue("sample_{1:configs$sample_size[i]}")
  results[[i]] <- list(
    "LIMMA_voom" = run_DA_method(assay(atlas_), colData(atlas_), "LIMMA_voom") |>
      da_metrics(nonnull, level = 0.3),
    "ANCOMBC" = run_DA_method(assay(atlas_), colData(atlas_), "ANCOMBC") |>
      da_metrics(nonnull, level = 0.3)
  )

  print(glue("{i}/{nrow(configs)}"))
}
```

```{r}
results0 <- results
results <- map_dfr(results, bind_rows, .id = "method") |>
  bind_rows() |>
  bind_cols(configs)

ggplot(results) +
  stat_pointinterval(aes(
    factor(sample_size), power, col = method)
  )

ggplot(results) +
  stat_pointinterval(aes(
    factor(sample_size), FDR, col = factor(n_nonnull)
  ))
```