---
title: "Marginal Analysis Example"
author: Kris Sankaran
output: readthedown::html_document
---

```{r}
library(gamboostLSS)
library(splines)
library(tidyverse)
library(scDesigner)
source("../data/helpers.R")
```

### Using SummarizedExperiment

* How many genera are available in this experiment object?
* What was the most common phylum in this dataset?
* What was the average participant age?

```{r}
atlas <- readRDS("../data/atlas.rds")

dim(atlas) # 125 genera
table(rowData(atlas)$Phylum)

mean(colData(atlas)$age)

# or just,
mean(atlas$age)
```

### Gaussian Mixture

```{r}
exper_grouped <- readRDS(url("https://github.com/krisrs1128/talks/raw/master/2024/20240611/data/exper_group.rds"))
exper_histogram(exper_grouped)
```

* Explain how the simulation code below works. 
* Modify it so that it accurate reflects the difference between groups for the first three genes.

```{r}
sim <- setup_simulator(exper_grouped, ~1, ~ GaussianLSS()) |>
  estimate()

sample(sim) |>
  exper_histogram()
```

```{r}
sim <- sim |>
  mutate(1:3, link = ~group) |>
  estimate()

sample(sim) |>
  exper_histogram()
```

### Gaussian over Time

```{r}
exper_ts <- readRDS("../data/exper_ts.rds")
exper_lineplot(exper_ts)
```

```{r}
sim <- setup_simulator(
  exper_ts,
  ~ ns(time, df = 7) * group,
  ~ GaussianLSS()
) |>
  estimate(nu = 0.01, mstop = 1000)

sample(sim) |>
  exper_lineplot()
```

```{r}
sim <- sim |>
  mutate(4:6, link = ~ ns(time, df = 7)) |>
  estimate(nu = 0.01, mstop = 1000)

sample(sim) |>
  exper_lineplot()
```


### Estimate and Visualize

```{r}
exper <- readRDS("../data/atlas.rds")
sim <- setup_simulator(
  exper,
  ~ bmi_group + age + log_depth,
  ~ ZINBLSS()
) |>
  estimate(nu = 0.001, mstop = 100)
```

Visualizing simulator quality.

```{r}
combined <- bind_rows(
  real = pivot_experiment(exper), # real data
  simulated = pivot_experiment(sample(sim)), # simulated
  .id = "source"
)

high_abundance <- combined |>
  filter(source == "real") |>
  group_by(feature) |>
  summarise(median = median(value)) |>
  slice_max(median, n = 20)

combined |>
  filter(feature %in% high_abundance$feature) |>
  ggplot() +
  geom_boxplot(
    aes(asinh(value), reorder(feature, value, median), fill = source)
  )
```

```{r}
combined |>
  filter(feature %in% high_abundance$feature) |>
  ggplot() +
  geom_point(
    aes(age, asinh(value), col = source), size = 0.4, alpha = 0.3
  ) +
  facet_wrap(~ reorder(feature, value, median), scales = "free_y")
```

### Apply to Power Analysis

```{r}

```